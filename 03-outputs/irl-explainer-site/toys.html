<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Toy Playground — IRL</title>

    <style>
      :root {
        --ink: #111827;
        --muted: #4b5563;
        --subtle: #6b7280;
        --border: #e5e7eb;
        --teal: #0d9488;
        --teal-light: #ccfbf1;
        --amber: #d97706;
        --amber-light: #fef3c7;

        --sans: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif;
        --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;
      }

      * { box-sizing: border-box; }
      html, body { height: 100%; }

      body {
        margin: 0;
        background: linear-gradient(180deg, #fff 0%, #f9fafb 50%, #fff 100%);
        color: var(--ink);
        font-family: var(--sans);
        line-height: 1.7;
        text-rendering: optimizeLegibility;
      }

      .topbar {
        position: sticky; top: 0; z-index: 50;
        background: rgba(255,255,255,0.82);
        -webkit-backdrop-filter: blur(10px);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid var(--border);
      }
      .topbar-inner {
        max-width: 860px; margin: 0 auto; padding: 12px 18px;
        display: flex; align-items: center; justify-content: space-between; gap: 12px;
      }
      .brand {
        display: inline-flex; align-items: center; gap: 10px;
        font-weight: 650; color: var(--ink); text-decoration: none; letter-spacing: -0.01em;
      }
      .brand svg { width: 14px; height: 14px; display: block; }
      .topbar a.util {
        font-family: var(--mono); font-size: 12px; color: var(--subtle); text-decoration: none;
      }
      .topbar a.util:hover { color: var(--ink); }

      .wrap { max-width: 860px; margin: 0 auto; padding: 28px 18px 80px; }

      .page-header {
        padding: 30px 0 24px; border-bottom: 1px solid var(--border); text-align: center;
      }
      h1 {
        font-size: clamp(28px, 3.5vw, 40px); line-height: 1.1;
        letter-spacing: -0.02em; margin: 0 0 8px;
      }
      .page-subtitle { font-family: var(--mono); font-size: 13px; color: var(--subtle); }

      p { margin: 12px 0; }

      h2 {
        font-size: 22px; line-height: 1.25; letter-spacing: -0.01em;
        margin: 32px 0 6px; padding-bottom: 6px; border-bottom: 1px solid var(--border);
      }
      .intro {
        color: var(--muted); font-size: 16px;
        max-width: 580px; margin: 10px auto 20px; text-align: center;
      }

      .contrast { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
      @media (max-width: 600px) { .contrast { grid-template-columns: 1fr; } }

      .panel {
        border: 1px solid var(--border); border-radius: 12px;
        background: #fff; overflow: hidden;
      }
      .panel-head {
        padding: 12px 14px 8px;
        display: flex; align-items: center; justify-content: space-between;
      }
      .panel-label {
        font-family: var(--mono); font-size: 11px; font-weight: 600;
        letter-spacing: 0.08em; text-transform: uppercase;
      }
      .panel-label.teal { color: var(--teal); }
      .panel-label.amber { color: var(--amber); }

      .run-btn {
        font-family: var(--mono); font-size: 11px; padding: 4px 10px;
        border-radius: 6px; border: 1px solid var(--border);
        background: #fff; cursor: pointer; transition: background 0.15s;
      }
      .run-btn:hover { background: #f9fafb; }
      .run-btn:disabled { cursor: not-allowed; opacity: 0.4; }

      .canvas-wrap {
        position: relative; width: 100%; aspect-ratio: 5 / 3;
        background: #fafafa; border-top: 1px solid var(--border);
      }
      .canvas-wrap canvas {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      }

      .panel-foot {
        padding: 8px 14px; font-family: var(--mono); font-size: 11px;
        line-height: 1.4; border-top: 1px solid var(--border);
        min-height: 34px; transition: background 0.4s, color 0.4s;
      }
      .panel-foot.neutral { background: #f9fafb; color: var(--subtle); }
      .panel-foot.teal { background: var(--teal-light); color: var(--teal); }
      .panel-foot.amber { background: var(--amber-light); color: var(--amber); }

      .aside {
        border-left: 3px solid var(--border); padding-left: 14px;
        margin: 22px 0; color: var(--muted); font-size: 15px;
      }

      footer {
        margin-top: 28px; padding-top: 18px;
        border-top: 1px solid var(--border); color: var(--subtle); font-size: 13px;
      }
      a {
        color: var(--ink); text-decoration: underline;
        text-underline-offset: 2px; text-decoration-thickness: 1px;
      }
      a:hover { text-decoration: none; }
      a:focus-visible, button:focus-visible { outline: 2px solid var(--ink); outline-offset: 2px; }
    </style>
  </head>
  <body>
    <header class="topbar">
      <div class="topbar-inner">
        <a class="brand" href="index.html" aria-label="Back to explainer">
          <svg viewBox="0 0 16 16" aria-hidden="true">
            <circle cx="8" cy="8" r="6" fill="none" stroke="currentColor" stroke-width="1.5"></circle>
            <circle cx="8" cy="8" r="2" fill="currentColor"></circle>
          </svg>
          IRL Toys
        </a>
        <a class="util" href="index.html">Back to Explainer</a>
      </div>
    </header>

    <div class="wrap">
      <div class="page-header">
        <h1>Toy Playground</h1>
        <div class="page-subtitle">Design experiments for IRL concepts</div>
      </div>

      <h2>Idempotent vs. Non-Idempotent</h2>
      <p class="intro">
        Press Run on each side. One constellation always forms the same shape.
        The other never does.
      </p>

      <div class="contrast">
        <div class="panel">
          <div class="panel-head">
            <span class="panel-label teal">Idempotent</span>
            <button class="run-btn" id="idem-btn" type="button">Run</button>
          </div>
          <div class="canvas-wrap"><canvas id="cv-idem"></canvas></div>
          <div class="panel-foot neutral" id="ft-idem">Same recipe, same dish. Press Run.</div>
        </div>
        <div class="panel">
          <div class="panel-head">
            <span class="panel-label amber">Non-Idempotent</span>
            <button class="run-btn" id="nonidem-btn" type="button">Run</button>
          </div>
          <div class="canvas-wrap"><canvas id="cv-nonidem"></canvas></div>
          <div class="panel-foot neutral" id="ft-nonidem">Same recipe, different dish. Press Run.</div>
        </div>
      </div>

      <p class="aside">
        The teal side is safe to rerun: the constellation always settles into
        the same shape. The amber side drifts: positions shift, new dots appear,
        and you can't tell which run was "right." Idempotency is what makes
        iteration trustworthy.
      </p>

      <h2>The Loop</h2>
      <p class="intro">
        You decide what to build. The AI does the work. Each cycle produces
        real files you can inspect, then you review and plan the next step.
      </p>

      <div class="panel" style="max-width:100%">
        <div class="panel-head">
          <span class="panel-label" style="color:var(--subtle)">Human &harr; AI &rarr; Files</span>
          <button class="run-btn" id="recipe-btn" type="button">Run Cycle</button>
        </div>
        <div class="canvas-wrap" style="aspect-ratio:5/2.5"><canvas id="cv-recipe"></canvas></div>
        <div class="panel-foot neutral" id="ft-recipe">Watching the loop&hellip;</div>
      </div>

      <p class="aside">
        You write a plan describing what you want. The AI reads it and produces
        files &mdash; reports, datasets, diagrams. You review the results, refine
        the plan, and run it again. Each cycle builds on the last.
      </p>

      <h2>The Process</h2>
      <p class="intro">
        What a single IRL cycle actually looks like &mdash; from plan to output to commit.
      </p>

      <div class="panel" style="max-width:100%" id="process-panel">
        <div class="panel-head">
          <span class="panel-label" style="color:var(--subtle)">One cycle, start to finish</span>
          <button class="run-btn" id="process-btn" type="button">Play</button>
        </div>
        <div id="process-stage" style="padding:16px 18px;min-height:320px;font-family:var(--mono);font-size:12.5px;line-height:1.6;background:#fafafa;border-top:1px solid var(--border);overflow:hidden;position:relative">
        </div>
        <div class="panel-foot neutral" id="ft-process">Watch an IRL cycle unfold.</div>
      </div>

      <p class="aside">
        This is everything that happens in one iteration: a plan states what you
        want, the AI produces real files, you review the diff, and commit. Nothing
        is hidden in chat history &mdash; it all lives in files you can inspect.
      </p>

      <footer><a href="index.html">Back to the explainer</a></footer>
    </div>

    <script>
    (function () {
      var N = 12;
      var R = 5;
      var LINE_DIST = 80;
      var SCATTER_MS = 300;
      var SETTLE_MS = 800;

      function ease(t) { return t < 0.5 ? 4*t*t*t : 1 - Math.pow(-2*t+2,3)/2; }

      /* ── Canvas boilerplate ── */
      function init(id) {
        var c = document.getElementById(id);
        var dpr = window.devicePixelRatio || 1;
        function fit() {
          var r = c.parentElement.getBoundingClientRect();
          c.width = r.width * dpr; c.height = r.height * dpr;
        }
        fit(); window.addEventListener("resize", fit);
        return { c: c, dpr: dpr, fit: fit };
      }
      function ctx(cv) {
        var g = cv.c.getContext("2d");
        g.setTransform(cv.dpr, 0, 0, cv.dpr, 0, 0);
        return g;
      }
      function dim(cv) { return { w: cv.c.width / cv.dpr, h: cv.c.height / cv.dpr }; }

      /* ── Seeded RNG (mulberry32) ── */
      function rng(s) {
        return function () {
          s |= 0; s = s + 0x6d2b79f5 | 0;
          var t = Math.imul(s ^ s >>> 15, 1 | s);
          t = (t + Math.imul(t ^ t >>> 7, 61 | t)) ^ t;
          return ((t ^ t >>> 14) >>> 0) / 4294967296;
        };
      }

      function seededPts(n, w, h, seed) {
        var r = rng(seed), pad = R + 14, pts = [];
        for (var i = 0; i < n; i++)
          pts.push({ x: pad + r() * (w - 2*pad), y: pad + r() * (h - 2*pad) });
        return pts;
      }
      function randPts(n, w, h) {
        var pad = R + 14, pts = [];
        for (var i = 0; i < n; i++)
          pts.push({ x: pad + Math.random()*(w-2*pad), y: pad + Math.random()*(h-2*pad) });
        return pts;
      }

      /* ── Drawing ── */
      function draw(g, pts, colors, w, h, lineColor) {
        g.clearRect(0, 0, w, h);

        /* constellation lines */
        g.strokeStyle = lineColor;
        g.lineWidth = 1;
        for (var i = 0; i < pts.length; i++) {
          for (var j = i + 1; j < pts.length; j++) {
            var dx = pts[i].x - pts[j].x, dy = pts[i].y - pts[j].y;
            var d = Math.sqrt(dx*dx + dy*dy);
            if (d < LINE_DIST) {
              var a = 0.25 * (1 - d / LINE_DIST);
              g.globalAlpha = a;
              g.beginPath();
              g.moveTo(pts[i].x, pts[i].y);
              g.lineTo(pts[j].x, pts[j].y);
              g.stroke();
            }
          }
        }

        /* dots */
        for (var k = 0; k < pts.length; k++) {
          g.globalAlpha = pts[k].a !== undefined ? pts[k].a : 1;
          g.beginPath();
          g.arc(pts[k].x, pts[k].y, R, 0, Math.PI * 2);
          g.fillStyle = colors[k % colors.length];
          g.fill();
        }
        g.globalAlpha = 1;
      }

      /* ── Two-phase animation: scatter out, then settle ── */
      function animate(cv, from, to, colors, lineColor, done) {
        var d = dim(cv);
        /* Phase 1: scatter from current positions outward */
        var scattered = [];
        var cx = d.w / 2, cy = d.h / 2;
        for (var i = 0; i < to.length; i++) {
          var src = from[i] || { x: cx, y: cy };
          var angle = Math.atan2(src.y - cy, src.x - cx) + (Math.random()-0.5)*1.2;
          var dist = 30 + Math.random() * 40;
          scattered.push({
            x: src.x + Math.cos(angle) * dist,
            y: src.y + Math.sin(angle) * dist,
          });
        }

        var start = null;
        var totalMs = SCATTER_MS + SETTLE_MS;

        function frame(ts) {
          if (!start) start = ts;
          var el = ts - start;
          var g = ctx(cv);
          var pts = [];

          if (el < SCATTER_MS) {
            /* Phase 1: current → scattered */
            var t1 = ease(el / SCATTER_MS);
            for (var i = 0; i < to.length; i++) {
              var src = from[i] || { x: cx, y: cy };
              pts.push({
                x: src.x + (scattered[i].x - src.x) * t1,
                y: src.y + (scattered[i].y - src.y) * t1,
                a: from[i] ? 1 : t1,
              });
            }
          } else {
            /* Phase 2: scattered → target */
            var t2 = ease(Math.min((el - SCATTER_MS) / SETTLE_MS, 1));
            for (var j = 0; j < to.length; j++) {
              pts.push({
                x: scattered[j].x + (to[j].x - scattered[j].x) * t2,
                y: scattered[j].y + (to[j].y - scattered[j].y) * t2,
                a: from[j] ? 1 : Math.min(1, (el / SCATTER_MS)),
              });
            }
          }

          draw(g, pts, colors, d.w, d.h, lineColor);

          if (el < totalMs) {
            requestAnimationFrame(frame);
          } else {
            /* final clean draw at exact targets */
            draw(g, to.map(function(p) { return { x:p.x, y:p.y, a:1 }; }), colors, d.w, d.h, lineColor);
            if (done) done(to);
          }
        }
        requestAnimationFrame(frame);
      }

      /* ── Color palettes ── */
      var tealPalette = ["#0d9488","#14b8a6","#2dd4bf","#5eead4","#99f6e4","#0f766e"];
      var amberPalette = ["#d97706","#f59e0b","#fbbf24","#fcd34d","#b45309","#92400e"];

      function pickColors(n, palette, seed) {
        var r = rng(seed), out = [];
        for (var i = 0; i < n; i++) out.push(palette[Math.floor(r() * palette.length)]);
        return out;
      }

      /* ══════════════════════════════════════
         IDEMPOTENT
         ══════════════════════════════════════ */
      var iCv = init("cv-idem");
      var iBtn = document.getElementById("idem-btn");
      var iFt = document.getElementById("ft-idem");
      var iRuns = 0, iCur = null;
      var SEED = 42;
      var iCol = pickColors(N, tealPalette, SEED);

      (function () {
        var d = dim(iCv);
        iCur = randPts(N, d.w, d.h);
        draw(ctx(iCv), iCur, iCol, d.w, d.h, "rgba(13,148,136,0.35)");
      })();

      iBtn.addEventListener("click", function () {
        iBtn.disabled = true;
        iRuns++;
        var d = dim(iCv);
        var targets = seededPts(N, d.w, d.h, SEED);
        animate(iCv, iCur, targets, iCol, "rgba(13,148,136,0.35)", function (final) {
          iCur = final;
          iBtn.disabled = false;
          iFt.className = "panel-foot teal";
          iFt.textContent = iRuns === 1
            ? "Run #1 \u2014 constellation formed."
            : "Run #" + iRuns + " \u2014 identical shape. Nothing changed.";
        });
      });

      /* ══════════════════════════════════════
         NON-IDEMPOTENT
         ══════════════════════════════════════ */
      var nCv = init("cv-nonidem");
      var nBtn = document.getElementById("nonidem-btn");
      var nFt = document.getElementById("ft-nonidem");
      var nRuns = 0, nCur = null, nCount = N;
      var nCol = pickColors(N + 30, amberPalette, 99);

      (function () {
        var d = dim(nCv);
        nCur = randPts(N, d.w, d.h);
        draw(ctx(nCv), nCur, nCol, d.w, d.h, "rgba(217,119,6,0.3)");
      })();

      nBtn.addEventListener("click", function () {
        nBtn.disabled = true;
        nRuns++;
        var d = dim(nCv);
        var extra = Math.floor(Math.random() * 2) + 1;
        var newN = nCount + extra;
        var targets = randPts(newN, d.w, d.h);

        /* Pad from with center-spawns for new dots */
        var from = (nCur || []).slice();
        while (from.length < newN) from.push({ x: d.w/2, y: d.h/2 });

        animate(nCv, from, targets, nCol, "rgba(217,119,6,0.3)", function (final) {
          nCur = final;
          nCount = newN;
          nBtn.disabled = false;
          nFt.className = "panel-foot amber";
          nFt.textContent = nRuns === 1
            ? "Run #1 \u2014 " + newN + " dots, random positions."
            : "Run #" + nRuns + " \u2014 " + newN + " dots. Shape changed again.";
        });
      });
    })();

    /* ══════════════════════════════════════════════
       TOY 2: THE LOOP — human ↔ AI → artifacts
       ══════════════════════════════════════════════ */
    (function () {
      var cv = (function (id) {
        var c = document.getElementById(id);
        var dpr = window.devicePixelRatio || 1;
        function fit() {
          var r = c.parentElement.getBoundingClientRect();
          c.width = r.width * dpr; c.height = r.height * dpr;
        }
        fit(); window.addEventListener("resize", fit);
        return { c: c, dpr: dpr };
      })("cv-recipe");

      var btn = document.getElementById("recipe-btn");
      var ft = document.getElementById("ft-recipe");
      var cycles = 0;
      var artifacts = [];
      var autoPlaying = false;
      var mono = "ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace";

      function getCtx() {
        var c = cv.c.getContext("2d");
        c.setTransform(cv.dpr, 0, 0, cv.dpr, 0, 0);
        return c;
      }
      function W() { return cv.c.width / cv.dpr; }
      function H() { return cv.c.height / cv.dpr; }
      function ease(t) { return t < 0.5 ? 2*t*t : 1 - Math.pow(-2*t+2,2)/2; }

      var HUMAN_C = "#0d9488";
      var AI_C = "#6b7280";
      var REVIEW_C = "#92400e";
      var ART_COLORS = ["#0d9488","#14b8a6","#2dd4bf","#0f766e","#5eead4"];

      function nodeR() { return Math.min(W(), H()) * 0.15; }

      function layout() {
        var w = W(), h = H();
        return { hx: w*0.22, hy: h*0.38, ax: w*0.78, ay: h*0.38, r: nodeR() };
      }

      /* Three bezier legs forming the loop */
      function loopPaths() {
        var w = W(), h = H(), L = layout(), r = L.r;
        return [
          /* 0: Human → AI (arc over top) */
          { sx: L.hx + r*0.85, sy: L.hy - r*0.5,
            c1x: w*0.38, c1y: h*0.08, c2x: w*0.62, c2y: h*0.08,
            ex: L.ax - r*0.85, ey: L.ay - r*0.5,
            color: HUMAN_C, label: "plan" },
          /* 1: AI → Files (curve down right) */
          { sx: L.ax + r*0.15, sy: L.ay + r,
            c1x: w*0.85, c1y: h*0.65, c2x: w*0.68, c2y: h*0.82,
            ex: w*0.58, ey: h*0.80,
            color: AI_C, label: "execute" },
          /* 2: Files → Human (curve up left) */
          { sx: w*0.42, sy: h*0.80,
            c1x: w*0.30, c1y: h*0.82, c2x: w*0.14, c2y: h*0.65,
            ex: L.hx - r*0.15, ey: L.hy + r,
            color: REVIEW_C, label: "review" },
        ];
      }

      function bezAt(p, t) {
        var u = 1 - t;
        return {
          x: u*u*u*p.sx + 3*u*u*t*p.c1x + 3*u*t*t*p.c2x + t*t*t*p.ex,
          y: u*u*u*p.sy + 3*u*u*t*p.c1y + 3*u*t*t*p.c2y + t*t*t*p.ey,
        };
      }

      function drawArrow(ctx, p) {
        var dx = p.ex - p.c2x, dy = p.ey - p.c2y;
        var len = Math.sqrt(dx*dx + dy*dy); dx /= len; dy /= len;
        var sz = 9, px = -dy*sz*0.45, py = dx*sz*0.45;
        ctx.fillStyle = p.color; ctx.globalAlpha = 0.35;
        ctx.beginPath();
        ctx.moveTo(p.ex, p.ey);
        ctx.lineTo(p.ex - dx*sz + px, p.ey - dy*sz + py);
        ctx.lineTo(p.ex - dx*sz - px, p.ey - dy*sz - py);
        ctx.closePath(); ctx.fill(); ctx.globalAlpha = 1;
      }

      function drawNode(ctx, x, y, r, color, dashed, label, sub, glow) {
        if (glow > 0) {
          ctx.fillStyle = color; ctx.globalAlpha = 0.07 * glow;
          ctx.beginPath(); ctx.arc(x, y, r*1.6, 0, Math.PI*2); ctx.fill();
          ctx.globalAlpha = 1;
        }
        ctx.fillStyle = color; ctx.globalAlpha = 0.08 + 0.05*glow;
        ctx.beginPath(); ctx.arc(x, y, r, 0, Math.PI*2); ctx.fill();
        ctx.globalAlpha = 1;
        ctx.strokeStyle = color; ctx.lineWidth = 1.5;
        if (dashed) ctx.setLineDash([4,3]);
        ctx.beginPath(); ctx.arc(x, y, r, 0, Math.PI*2); ctx.stroke();
        ctx.setLineDash([]);
        ctx.fillStyle = color;
        ctx.font = "700 20px " + mono;
        ctx.textAlign = "center"; ctx.textBaseline = "middle";
        ctx.fillText(label, x, y - 8);
        if (sub) {
          ctx.font = "400 14px " + mono; ctx.globalAlpha = 0.55;
          ctx.fillText(sub, x, y + 14); ctx.globalAlpha = 1;
        }
      }

      function roundRect(ctx, x, y, w, h, r) {
        ctx.moveTo(x+r,y); ctx.lineTo(x+w-r,y);
        ctx.quadraticCurveTo(x+w,y,x+w,y+r); ctx.lineTo(x+w,y+h-r);
        ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h); ctx.lineTo(x+r,y+h);
        ctx.quadraticCurveTo(x,y+h,x,y+h-r); ctx.lineTo(x,y+r);
        ctx.quadraticCurveTo(x,y,x+r,y); ctx.closePath();
      }

      function drawScene(ctx, gh, ga) {
        var w = W(), h = H(), L = layout(), P = loopPaths();
        ctx.clearRect(0, 0, w, h);

        /* Loop paths + arrowheads + labels */
        for (var i = 0; i < P.length; i++) {
          var p = P[i];
          ctx.strokeStyle = p.color; ctx.globalAlpha = 0.15;
          ctx.lineWidth = 1.5; ctx.setLineDash([3,4]);
          ctx.beginPath();
          ctx.moveTo(p.sx, p.sy);
          ctx.bezierCurveTo(p.c1x, p.c1y, p.c2x, p.c2y, p.ex, p.ey);
          ctx.stroke();
          ctx.setLineDash([]); ctx.globalAlpha = 1;
          drawArrow(ctx, p);
          var mid = bezAt(p, 0.5);
          ctx.fillStyle = p.color; ctx.globalAlpha = 0.5;
          ctx.font = "600 15px " + mono;
          ctx.textAlign = "center"; ctx.textBaseline = "middle";
          var offY = i === 0 ? -14 : 0;
          var offX = i === 1 ? 18 : (i === 2 ? -18 : 0);
          ctx.fillText(p.label, mid.x + offX, mid.y + offY);
          ctx.globalAlpha = 1;
        }

        /* Nodes */
        drawNode(ctx, L.hx, L.hy, L.r, HUMAN_C, false, "HUMAN", "reason \xb7 plan", gh||0);
        drawNode(ctx, L.ax, L.ay, L.r, AI_C, true, "AI", "execute", ga||0);

        /* Artifact label + rectangles */
        if (artifacts.length > 0) {
          ctx.fillStyle = AI_C; ctx.globalAlpha = 0.45;
          ctx.font = "600 15px " + mono; ctx.textAlign = "center";
          ctx.fillText("FILES", w*0.50, h*0.66);
          ctx.globalAlpha = 1;
        }
        for (var j = 0; j < artifacts.length; j++) {
          var a = artifacts[j];
          ctx.fillStyle = a.color; ctx.globalAlpha = 0.85;
          ctx.beginPath(); roundRect(ctx, a.x, a.y, a.w, a.h, 3); ctx.fill();
          ctx.globalAlpha = 1;
        }
      }

      /* Particle drawing helper */
      function drawParticles(ctx, path, el, phaseStart, count, stagger, flowMs, color) {
        for (var i = 0; i < count; i++) {
          var lt = (el - phaseStart - i*stagger) / flowMs;
          if (lt < 0 || lt > 1) continue;
          var et = ease(lt);
          for (var s = 0; s < 6; s++) {
            var tt = et - (s/6)*0.12;
            if (tt < 0) continue;
            var tp = bezAt(path, tt);
            ctx.globalAlpha = (1-s/6)*0.25;
            ctx.beginPath();
            ctx.arc(tp.x, tp.y, 4.5*(1-s/6*0.4), 0, Math.PI*2);
            ctx.fillStyle = color; ctx.fill();
          }
          ctx.globalAlpha = 1;
          var pos = bezAt(path, et);
          ctx.beginPath();
          ctx.arc(pos.x, pos.y, 4.5, 0, Math.PI*2);
          ctx.fillStyle = color; ctx.fill();
        }
      }

      /* Initial draw */
      drawScene(getCtx(), 0, 0);

      /* Animation timing */
      var PLAN_N = 3, EXEC_N = 3, REV_N = 2;
      var FLOW_MS = 700, STAGGER = 70;
      var phase1T = FLOW_MS + (PLAN_N-1)*STAGGER;
      var GAP = 80;
      var phase2S = phase1T + GAP;
      var phase2T = FLOW_MS + (EXEC_N-1)*STAGGER;
      var phase3S = phase2S + phase2T + GAP;
      var phase3T = FLOW_MS + (REV_N-1)*STAGGER;
      var totalT = phase3S + phase3T;

      /* Run one cycle, call onDone when finished */
      function runOneCycle(onDone) {
        btn.disabled = true;
        cycles++;
        var w = W(), h = H(), P = loopPaths();
        var t0 = null;

        function frame(ts) {
          if (!t0) t0 = ts;
          var el = ts - t0;
          var c = getCtx();

          /* Node glow per phase */
          var gh = 0, ga = 0;
          if (el < phase1T)
            gh = Math.sin(el/phase1T * Math.PI) * 0.8;
          else if (el >= phase2S && el < phase2S + phase2T)
            ga = Math.sin((el - phase2S)/phase2T * Math.PI) * 0.8;
          else if (el >= phase3S)
            gh = Math.sin((el - phase3S)/phase3T * Math.PI) * 0.4;

          drawScene(c, gh, ga);

          /* Phase 1: Human → AI  (plan) */
          drawParticles(c, P[0], el, 0, PLAN_N, STAGGER, FLOW_MS, HUMAN_C);
          /* Phase 2: AI → Artifacts (execute) */
          drawParticles(c, P[1], el, phase2S, EXEC_N, STAGGER, FLOW_MS, AI_C);
          /* Phase 3: Artifacts → Human (review) */
          drawParticles(c, P[2], el, phase3S, REV_N, STAGGER, FLOW_MS, REVIEW_C);

          c.globalAlpha = 1;

          if (el < totalT) {
            requestAnimationFrame(frame);
          } else {
            /* Settle new artifacts */
            var artW = 24, artH = 28, artGap = 5;
            var cols = Math.floor((w * 0.24) / (artW + artGap));
            if (cols < 1) cols = 1;
            for (var j = 0; j < EXEC_N; j++) {
              var idx = artifacts.length;
              var col = idx % cols;
              var row = Math.floor(idx / cols);
              artifacts.push({
                x: w*0.38 + col*(artW + artGap),
                y: h*0.70 + row*(artH + artGap),
                w: artW, h: artH,
                color: ART_COLORS[j % ART_COLORS.length],
              });
            }
            drawScene(getCtx(), 0, 0);
            ft.className = "panel-foot teal";
            ft.textContent = "Cycle #" + cycles + " \u2014 " + artifacts.length +
              " file" + (artifacts.length === 1 ? "" : "s") + " produced. Loop complete.";
            if (!autoPlaying) btn.disabled = false;
            if (onDone) onDone();
          }
        }
        requestAnimationFrame(frame);
      }

      /* Auto-play 3 cycles on load */
      var AUTO_CYCLES = 3, AUTO_PAUSE = 900;
      function autoPlay(n) {
        autoPlaying = true;
        btn.textContent = "Playing\u2026";
        btn.disabled = true;
        runOneCycle(function () {
          if (n > 1) {
            setTimeout(function () { autoPlay(n - 1); }, AUTO_PAUSE);
          } else {
            autoPlaying = false;
            btn.disabled = false;
            btn.textContent = "Run Cycle";
          }
        });
      }
      setTimeout(function () { autoPlay(AUTO_CYCLES); }, 600);

      /* Manual trigger */
      btn.addEventListener("click", function () {
        if (!autoPlaying) runOneCycle(null);
      });
    })();

    /* ══════════════════════════════════════════════
       TOY 3: THE PROCESS — one IRL cycle, real content
       ══════════════════════════════════════════════ */
    (function () {
      var stage = document.getElementById("process-stage");
      var btn = document.getElementById("process-btn");
      var ft = document.getElementById("ft-process");
      var mono = "ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace";
      var running = false;

      var TEAL = "#0d9488";
      var GRAY = "#6b7280";
      var AMBER = "#92400e";
      var GREEN = "#16a34a";

      /* Typing animation helper */
      function typeText(el, text, charMs, done) {
        var i = 0;
        function next() {
          if (i < text.length) {
            el.textContent += text[i];
            i++;
            setTimeout(next, charMs);
          } else if (done) { done(); }
        }
        next();
      }

      /* Create a styled document block */
      function makeDoc(title, titleColor) {
        var wrap = document.createElement("div");
        wrap.style.cssText = "border:1px solid #e5e7eb;border-radius:8px;background:#fff;margin-bottom:12px;overflow:hidden;opacity:0;transition:opacity 0.4s";
        var head = document.createElement("div");
        head.style.cssText = "padding:8px 12px;border-bottom:1px solid #e5e7eb;display:flex;align-items:center;gap:8px";
        var dot = document.createElement("span");
        dot.style.cssText = "width:8px;height:8px;border-radius:50%;background:" + titleColor;
        var lbl = document.createElement("span");
        lbl.style.cssText = "font-size:11px;font-weight:600;letter-spacing:0.06em;text-transform:uppercase;color:" + titleColor;
        lbl.textContent = title;
        head.appendChild(dot);
        head.appendChild(lbl);
        var body = document.createElement("div");
        body.style.cssText = "padding:10px 12px;white-space:pre-wrap;color:#374151;font-size:12px;line-height:1.6;min-height:24px";
        wrap.appendChild(head);
        wrap.appendChild(body);
        return { wrap: wrap, body: body };
      }

      /* Status line helper */
      function makeStatus(text, color) {
        var s = document.createElement("div");
        s.style.cssText = "padding:6px 0;font-size:11px;font-weight:600;letter-spacing:0.04em;color:" + color + ";opacity:0;transition:opacity 0.3s";
        s.textContent = text;
        return s;
      }

      function sleep(ms) { return new Promise(function(r) { setTimeout(r, ms); }); }

      /* The plan content */
      var planText = "## Task: Summarize ERP data\n\n- Input:  02-data/raw/erp-components.csv\n- Output: 03-outputs/summary.html\n- Done:   Table of means by group";

      /* The output content */
      var outputText = "<h3>ERP Summary</h3>\n\nGroup    N    P300 mean   Latency\n─────    ──   ─────────   ───────\nALS      24   4.2 \u00B5V      342 ms\nControl  28   6.8 \u00B5V      318 ms\n\np = 0.023 (t-test, two-tailed)";

      /* The diff content */
      var diffText = " 03-outputs/summary.html | 12 ++++++++++++\n 1 file changed, 12 insertions(+)";

      async function runProcess() {
        if (running) return;
        running = true;
        btn.disabled = true;
        btn.textContent = "Playing\u2026";
        stage.innerHTML = "";
        ft.className = "panel-foot neutral";
        ft.textContent = "Step 1 of 4 \u2014 Writing the plan\u2026";

        /* Step 1: Plan appears */
        var plan = makeDoc("main-plan.md", TEAL);
        stage.appendChild(plan.wrap);
        await sleep(100);
        plan.wrap.style.opacity = "1";
        await sleep(300);
        await new Promise(function(resolve) {
          typeText(plan.body, planText, 18, resolve);
        });
        await sleep(600);

        /* Step 2: AI executes */
        ft.textContent = "Step 2 of 4 \u2014 AI reading plan and executing\u2026";
        var status1 = makeStatus("\u25B6 AI executing\u2026", GRAY);
        stage.appendChild(status1);
        await sleep(100);
        status1.style.opacity = "1";
        await sleep(400);

        /* Pulsing dots effect */
        var dots = 0;
        var dotTimer = setInterval(function() {
          dots = (dots + 1) % 4;
          status1.textContent = "\u25B6 AI executing" + ".".repeat(dots);
        }, 300);
        await sleep(1800);
        clearInterval(dotTimer);
        status1.textContent = "\u2713 AI finished";
        status1.style.color = GREEN;
        await sleep(400);

        /* Step 3: Output appears */
        ft.textContent = "Step 3 of 4 \u2014 Output produced";
        var output = makeDoc("03-outputs/summary.html", AMBER);
        stage.appendChild(output.wrap);
        await sleep(100);
        output.wrap.style.opacity = "1";
        await sleep(200);
        await new Promise(function(resolve) {
          typeText(output.body, outputText, 14, resolve);
        });
        await sleep(600);

        /* Step 4: Review + commit */
        ft.textContent = "Step 4 of 4 \u2014 Review diff and commit";
        var status2 = makeStatus("$ git diff --stat", GRAY);
        stage.appendChild(status2);
        await sleep(100);
        status2.style.opacity = "1";
        await sleep(400);

        var diffDoc = makeDoc("git diff", GRAY);
        diffDoc.body.style.color = GREEN;
        diffDoc.body.style.fontSize = "11px";
        stage.appendChild(diffDoc.wrap);
        await sleep(100);
        diffDoc.wrap.style.opacity = "1";
        await sleep(200);
        await new Promise(function(resolve) {
          typeText(diffDoc.body, diffText, 20, resolve);
        });
        await sleep(500);

        var status3 = makeStatus("\u2713 Committed \u2014 checkpoint saved", GREEN);
        stage.appendChild(status3);
        await sleep(100);
        status3.style.opacity = "1";

        ft.className = "panel-foot teal";
        ft.textContent = "Cycle complete \u2014 plan \u2192 execute \u2192 output \u2192 commit. Everything is in files you can inspect.";

        await sleep(800);
        running = false;
        btn.disabled = false;
        btn.textContent = "Replay";
      }

      /* Auto-play on load after a delay */
      setTimeout(runProcess, 1200);

      btn.addEventListener("click", function() {
        if (!running) runProcess();
      });
    })();
    </script>
  </body>
</html>
